# 实现聊天记录本地持久化与长按交互功能

我将分两个阶段实现您的需求：首先构建本地数据库层以保存聊天记录，然后更新 UI 以支持长按复制和追问功能。

## 阶段一：聊天记录本地持久化 (Persistence)

### 1. 数据库架构 (Database Layer)
- **创建转换器 (`Converters.kt`)**: 
  - 使用 Kotlin Serialization 将复杂对象（如 `List<WebSearchResult>` 和 `Role`）转换为 JSON 字符串存储，确保数据完整性。
- **创建实体类 (`ChatMessageEntity.kt`)**: 
  - 映射 `ChatMessage` 数据模型，作为数据库表结构。包含 `id`, `role`, `content`, `reasoningContent`, `searchResults` 等字段。
- **创建数据访问对象 (`ChatDao.kt`)**: 
  - 提供 `getAllMessages()` (获取历史记录), `insertMessage()` (插入/更新), `deleteAllMessages()` (清空记录) 接口。
- **更新数据库 (`AppDatabase.kt`)**: 
  - 注册新的 Entity 和 DAO。

### 2. 数据仓库与业务逻辑 (Repository & ViewModel)
- **创建 `ChatHistoryRepository`**: 
  - 封装对 `ChatDao` 的调用，提供简洁的挂起函数供 ViewModel 使用。
- **更新 `ChatViewModel`**:
  - **初始化加载**: App 启动时从数据库加载历史消息恢复会话。
  - **实时保存**: 发送消息和接收完整回复后，自动保存消息到数据库。
  - **开启新对话**: 用户点击“新对话”时，调用 `deleteAllMessages()` 清空数据库记录。
- **依赖注入 (`MainActivity.kt`)**: 
  - 初始化 `ChatHistoryRepository` 并注入到 `ChatViewModelFactory` 中。

## 阶段二：UI 交互优化 (UI & Interaction)

### 1. 长按菜单 (Context Menu)
- **修改 `ChatBubble` 组件**:
  - 为消息内容区域添加 `combinedClickable` (支持长按手势)。
  - 实现 `DropdownMenu`，在长按位置弹出菜单。

### 2. 功能实现
- **复制回答 (Copy Answer)**:
  - 点击“复制”时，将 `message.content` (仅回答正文，不含思考过程和搜索结果) 复制到剪贴板。
- **追问 (Follow-up)**:
  - 点击“追问”时，将该条回答的内容以引用格式 (`> 内容...`) 自动填入输入框，方便用户基于此内容继续提问。

## 技术细节
- **数据格式**: 使用 JSON 序列化存储复杂字段，避免多表关联的复杂性。
- **UI 组件**: 使用 Material3 的 `DropdownMenu` 和 `LocalClipboardManager`。
- **状态同步**: 确保数据库操作在 IO 线程执行，不阻塞 UI。
