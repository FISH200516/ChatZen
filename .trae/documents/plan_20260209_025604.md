# Implementation Plan: Enhanced Chat, Settings, and Usage Features

This plan outlines the steps to implement the requested features, including the smart "Deep Thinking" logic.

## 1. Project Dependencies & Infrastructure
### **Add Libraries**
- **Room Database**: For storing token usage logs locally.
- **Vico Charts**: For displaying usage statistics graphs (Compose M3 compatible).
- **Update Gradle**: Add implementations in `libs.versions.toml` and `build.gradle.kts`.

### **Database Setup**
- Create `UsageEntity`: Stores `timestamp`, `provider`, `model`, `inputTokens`, `outputTokens`.
- Create `UsageDao`: Methods to insert logs and query usage stats by date range.
- Create `AppDatabase`: Room database instance.
- Create `UsageRepository`: Abstraction layer for usage data access.

## 2. Settings Page Refactor
### **UI Changes**
- **Main Settings View**: Display a list of Service Providers (OpenAI, Claude, Gemini, etc.).
- **Provider Detail View**: 
  - Input field for API Key.
  - "Save & Verify" button.
  - Display list of "Available Models" auto-fetched after saving.

### **Logic Updates**
- **SettingsViewModel**: Handle navigation and "Fetch Models" logic.
- **Auto-Fetch Models**: Trigger API call to fetch/validate models on save.
- **Persistence**: Store available models in DataStore.

## 3. Chat Page Enhancements
### **Smart Deep Thinking Logic (New)**
- **Capability Check**: Implement logic to detect if a model supports "Deep Thinking" (e.g., based on model ID keywords like "o1", "r1", "reasoning").
- **Button Behavior**:
  - **Supported**: Button is active. Clicking toggles "Thinking Mode".
  - **Unsupported**: Button is disabled (greyed out).
- **State Sync**: Button availability updates immediately when switching models.

### **Input Area Updates**
- Add "Deep Thinking" toggle button with the logic above.
- Add "Switch Model" button in the input area.

### **Model Switching Logic**
- **Hierarchical Selector**: BottomSheet with Provider -> Model selection.
- **Filtered List**: Only show valid/saved models.

### **Token Tracking**
- Save token usage to Room DB after message exchanges.

## 4. Usage Statistics Page
### **UI Implementation**
- **Time Filters**: Year / Month / Day buttons.
- **Visual Charts**: Vico charts for token usage.
- **Summary**: Total tokens used.

### **Logic**
- Fetch and aggregate data from `UsageRepository` for charts.

## Execution Order
1.  **Infrastructure**: Add dependencies, set up Room.
2.  **Settings**: Refactor Settings UI, implement Model Fetching.
3.  **Chat**: Implement UI, Model Switcher, and **Smart Deep Thinking Logic**.
4.  **Usage**: Build Usage Screen with charts.
